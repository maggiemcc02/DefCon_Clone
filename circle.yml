machine:
  services:
    - docker

dependencies:
  override:
    - /bin/true

test:
  override:
    - >
        docker run
        -v $(pwd):/home/fenics/defcon
        -w /home/fenics/defcon
        quay.io/fenicsproject/dev:py3
        '
        pip3 install --user h5py

        pip3 install --user .

        mpirun -n 2 python3 -m pytest -vxl --junitxml report.xml
        '

  post:
    -mkdir -p $CIRCLE_TEST_REPORTS/junit
    -cp report.xml $CIRCLE_TEST_REPORTS/junit
    -cp report.xml $CIRCLE_ARTIFACTS
    -find -name "*.pdf" -exec cp --parents {} $CIRCLE_ARTIFACTS \;
